      - name: Find Changed Post and Extract Info
        id: check_post
        shell: python
        run: |
          import os, re, datetime, subprocess

          # 1. 直接获取本次提交中【新增或修改】的 posts 文件
          result = subprocess.run(['git', 'diff-tree', '--no-commit-id', '--name-only', '-r', 'HEAD'], capture_output=True, text=True)
          changed_files = [f for f in result.stdout.splitlines() if f.startswith('src/content/posts/') and f.endswith(('.md', '.mdx'))]

          if not changed_files:
              print("No post changes detected in this commit.")
              with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                  env_file.write("SHOULD_NOTIFY=false\n")
              exit(0)

          # 2. 如果有多个变动，取其中 published 日期最晚的一个
          date_pattern = re.compile(r'^published:\s*["\']?(\d{4}-\d{2}-\d{2})', re.MULTILINE)
          latest_file = None
          latest_date = None

          for path in changed_files:
              if os.path.exists(path):
                  with open(path, 'r', encoding='utf-8') as f:
                      match = date_pattern.search(f.read())
                      if match:
                          curr_date = datetime.datetime.strptime(match.group(1), '%Y-%m-%d')
                          if latest_date is None or curr_date > latest_date:
                              latest_date = curr_date
                              latest_file = path

          # 3. 如果没找到 published 字段（比如是草稿），默认取变动列表里的第一个
          if not latest_file:
              latest_file = changed_files[0]

          print(f"✅ Detected new post: {latest_file}")
          with open(os.environ['GITHUB_ENV'], 'a') as env_file:
              env_file.write(f"LATEST_POST_PATH={latest_file}\n")
              env_file.write("SHOULD_NOTIFY=true\n")

      - name: Notify Moepush
        if: success() && env.SHOULD_NOTIFY == 'true'
        run: |
          FILE_PATH="${{ env.LATEST_POST_PATH }}"
          
          # 提取标题和描述
          TITLE=$(grep '^title:' "$FILE_PATH" | head -n 1 | sed 's/title: //; s/"//g; s/ '\''//g')
          DESC=$(grep '^description:' "$FILE_PATH" | head -n 1 | sed 's/description: //; s/"//g; s/ '\''//g')
          
          if [ -z "$DESC" ] || [ "$DESC" == "''" ]; then DESC="Fuwari 博客发布了新内容，点击查看详情！"; fi
          
          FILENAME=$(basename "$FILE_PATH" | cut -d. -f1)
          BLOG_URL="https://blog.031312.xyz/posts/$FILENAME"

          curl -X POST "${{ secrets.MOEPUSH_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"msgtype\": \"markdown\",
                  \"articles\": {
                    \"title\": \"$TITLE\",
                    \"description\": \"$DESC\",
                    \"url\": \"$BLOG_URL\"
                  }
                }"
