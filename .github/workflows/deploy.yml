name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
      - name: Install, build, and upload your site
        uses: withastro/action@v3

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Find Changed Post and Extract Rich Info
        id: check_post
        shell: python
        run: |
          import os, re, subprocess

          # 1. è·å–å˜åŠ¨æ–‡ä»¶
          cmd = ['git', '-c', 'core.quotepath=false', 'diff-tree', '--no-commit-id', '--name-only', '-r', 'HEAD']
          result = subprocess.run(cmd, capture_output=True, text=True, encoding='utf-8')
          changed_files = [f.strip() for f in result.stdout.splitlines() if f.startswith('src/content/posts/') and f.endswith(('.md', '.mdx'))]

          if not changed_files:
              with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                  env_file.write("SHOULD_NOTIFY=false\n")
              exit(0)

          target_file = changed_files[0] 

          def extract(pattern, content, default=""):
              match = re.search(pattern, content, re.MULTILINE)
              if match:
                  val = match.group(1).strip().strip("'").strip('"')
                  return val if val else default
              return default

          with open(target_file, 'r', encoding='utf-8') as f:
              content = f.read()
              title = extract(r'^title:\s*(.*)', content, "æ–°åšæ–‡å‘å¸ƒ")
              desc = extract(r'^description:\s*(.*)', content, "ç‚¹å‡»åŸæ–‡æŸ¥çœ‹è¯¦æƒ…")
              category = extract(r'^category:\s*(.*)', content, "æœªåˆ†ç±»")
              img = extract(r'^image:\s*(.*)', content, "")
              
              tags_match = re.search(r'^tags:\s*\[(.*)\]', content, re.MULTILINE)
              tags = " ".join([f"#{t.strip()}" for t in tags_match.group(1).split(',') if t.strip()]) if tags_match else "#åšå®¢æ›´æ–°"

          with open(os.environ['GITHUB_ENV'], 'a', encoding='utf-8') as env_file:
              # ä»…ä¿ç•™ Moepush æ¨¡æ¿éœ€è¦çš„å˜é‡
              env_file.write(f"POST_TITLE={title.replace('\"', '')}\n")
              # æ„é€ ä¸€ä¸ªçº¯å‡€çš„ description ä¾› Moepush æ¨¡æ¿å¼•ç”¨
              # åŒ…å«ï¼šæ‘˜è¦ã€åˆ†ç±»ã€æ ‡ç­¾
              rich_desc = f"{desc}\\n\\n---\\nğŸ“‚ åˆ†ç±»ï¼š{category}\\nğŸ·ï¸ æ ‡ç­¾ï¼š{tags}"
              env_file.write(f"POST_RICH_DESC={rich_desc.replace('\"', '')}\n")
              env_file.write(f"POST_IMAGE={img}\n")
              env_file.write(f"LATEST_POST_PATH={target_file}\n")
              env_file.write("SHOULD_NOTIFY=true\n")

      - name: Notify Moepush
        if: success() && env.SHOULD_NOTIFY == 'true'
        run: |
          FILENAME=$(basename "${{ env.LATEST_POST_PATH }}" | cut -d. -f1)
          BLOG_URL="https://blog.031312.xyz/posts/$FILENAME"
          
          # å°é¢å›¾é€»è¾‘
          PIC_URL="${{ env.POST_IMAGE }}"
          if [ -z "$PIC_URL" ] || [ "$PIC_URL" == "''" ]; then
            PIC_URL="https://picsum.photos/seed/${FILENAME}/800/400"
          elif [[ ! $PIC_URL == http* ]]; then
            PIC_URL="https://blog.031312.xyz$PIC_URL"
          fi
          
          # ç›´æ¥å‘é€ï¼Œ description ä½¿ç”¨æˆ‘ä»¬ç»„åˆå¥½çš„å¯Œæ–‡æœ¬
          curl -X POST "${{ secrets.MOEPUSH_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"msgtype\": \"markdown\",
                  \"articles\": {
                    \"title\": \"$POST_TITLE\",
                    \"description\": \"$POST_RICH_DESC\",
                    \"url\": \"$BLOG_URL\",
                    \"picurl\": \"$PIC_URL\"
                  }
                }"
