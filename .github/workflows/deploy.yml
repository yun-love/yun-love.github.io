name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
      - name: Install, build, and upload your site
        uses: withastro/action@v3

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Find Changed Post and Extract Info
        id: check_post
        shell: python
        run: |
          import os, re, datetime, subprocess

          # 1. 强制 Git 不转义中文路径，并获取变动文件
          # 使用 -c core.quotepath=false 解决 \350\277... 这种乱码问题
          cmd = ['git', '-c', 'core.quotepath=false', 'diff-tree', '--no-commit-id', '--name-only', '-r', 'HEAD']
          result = subprocess.run(cmd, capture_output=True, text=True, encoding='utf-8')
          
          # 过滤出文章目录下的 md/mdx 文件
          changed_files = [f.strip() for f in result.stdout.splitlines() if f.startswith('src/content/posts/') and f.endswith(('.md', '.mdx'))]

          if not changed_files:
              print("DEBUG: Git reported changed files: " + result.stdout)
              print("No post changes detected in src/content/posts/.")
              with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                  env_file.write("SHOULD_NOTIFY=false\n")
              exit(0)

          # 2. 寻找变动文件中 published 日期最晚的一个
          date_pattern = re.compile(r'^published:\s*["\']?(\d{4}-\d{2}-\d{2})', re.MULTILINE)
          latest_file = None
          latest_date = None

          for path in changed_files:
              if os.path.exists(path):
                  try:
                      with open(path, 'r', encoding='utf-8') as f:
                          content = f.read()
                          match = date_pattern.search(content)
                          if match:
                              curr_date = datetime.datetime.strptime(match.group(1), '%Y-%m-%d')
                              if latest_date is None or curr_date > latest_date:
                                  latest_date = curr_date
                                  latest_file = path
                  except Exception as e:
                      print(f"Error reading {path}: {e}")

          # 3. 兜底逻辑：如果没找到日期，取变动列表第一个
          if not latest_file:
              latest_file = changed_files[0]

          print(f"✅ Found updated post: {latest_file}")
          with open(os.environ['GITHUB_ENV'], 'a') as env_file:
              env_file.write(f"LATEST_POST_PATH={latest_file}\n")
              env_file.write("SHOULD_NOTIFY=true\n")

      - name: Notify Moepush
        if: success() && env.SHOULD_NOTIFY == 'true'
        run: |
          FILE_PATH="${{ env.LATEST_POST_PATH }}"
          
          # 提取标题和描述，增加对中文内容的引号处理
          TITLE=$(grep '^title:' "$FILE_PATH" | head -n 1 | sed 's/title: //; s/"//g; s/ '\''//g')
          DESC=$(grep '^description:' "$FILE_PATH" | head -n 1 | sed 's/description: //; s/"//g; s/ '\''//g')
          
          if [ -z "$DESC" ] || [ "$DESC" == "''" ]; then DESC="Fuwari 博客发布了新内容，点击查看详情！"; fi
          
          FILENAME=$(basename "$FILE_PATH" | cut -d. -f1)
          BLOG_URL="https://blog.031312.xyz/posts/$FILENAME"

          curl -X POST "${{ secrets.MOEPUSH_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"msgtype\": \"markdown\",
                  \"articles\": {
                    \"title\": \"$TITLE\",
                    \"description\": \"$DESC\",
                    \"url\": \"$BLOG_URL\"
                  }
                }"
