name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout your repository
        uses: actions/checkout@v4
      - name: Install, build, and upload your site
        uses: withastro/action@v3

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Find Changed Post and Extract Rich Info
        id: check_post
        shell: python
        run: |
          import os, re, datetime, subprocess

          # 1. èŽ·å–å˜åŠ¨æ–‡ä»¶
          cmd = ['git', '-c', 'core.quotepath=false', 'diff-tree', '--no-commit-id', '--name-only', '-r', 'HEAD']
          result = subprocess.run(cmd, capture_output=True, text=True, encoding='utf-8')
          changed_files = [f.strip() for f in result.stdout.splitlines() if f.startswith('src/content/posts/') and f.endswith(('.md', '.mdx'))]

          if not changed_files:
              with open(os.environ['GITHUB_ENV'], 'a') as env_file:
                  env_file.write("SHOULD_NOTIFY=false\n")
              exit(0)

          target_file = changed_files[0] 

          # 2. å¢žå¼ºæå–é€»è¾‘
          def extract(pattern, content, default=""):
              match = re.search(pattern, content, re.MULTILINE)
              if match:
                  val = match.group(1).strip().strip("'").strip('"')
                  return val if val else default
              return default

          with open(target_file, 'r', encoding='utf-8') as f:
              content = f.read()
              title = extract(r'^title:\s*(.*)', content, "æ— æ ‡é¢˜")
              desc = extract(r'^description:\s*(.*)', content, "ç‚¹å‡»é“¾æŽ¥é˜…è¯»å…¨æ–‡...")
              date = extract(r'^published:\s*(.*)', content, datetime.datetime.now().strftime('%Y-%m-%d'))
              category = extract(r'^category:\s*(.*)', content, "æœªåˆ†ç±»")
              img = extract(r'^image:\s*(.*)', content, "")
              
              tags_match = re.search(r'^tags:\s*\[(.*)\]', content, re.MULTILINE)
              tags = " ".join([f"#{t.strip()}" for t in tags_match.group(1).split(',')]) if tags_match else "#æ—¥å¸¸"

          with open(os.environ['GITHUB_ENV'], 'a', encoding='utf-8') as env_file:
              env_file.write(f"POST_TITLE={title}\n")
              env_file.write(f"POST_DESC={desc}\n")
              env_file.write(f"POST_DATE={date}\n")
              env_file.write(f"POST_CATE={category}\n")
              env_file.write(f"POST_TAGS={tags}\n")
              env_file.write(f"POST_IMAGE={img}\n")
              env_file.write(f"LATEST_POST_PATH={target_file}\n")
              env_file.write("SHOULD_NOTIFY=true\n")

      - name: Notify Moepush with Rich Style
        if: success() && env.SHOULD_NOTIFY == 'true'
        run: |
          FILENAME=$(basename "${{ env.LATEST_POST_PATH }}" | cut -d. -f1)
          BLOG_URL="https://blog.031312.xyz/posts/$FILENAME"
          
          # å¤„ç†é¢„è§ˆå›¾å…œåº•é€»è¾‘
          PIC_URL="${{ env.POST_IMAGE }}"
          if [ -z "$PIC_URL" ] || [ "$PIC_URL" == "''" ]; then
            PIC_URL="https://picsum.photos/seed/${FILENAME}/800/400" # æ ¹æ®æ–‡ä»¶åç”Ÿæˆçš„éšæœºå›¾ï¼Œä¿è¯æ¯ç¯‡éƒ½ä¸ä¸€æ ·
          elif [[ ! $PIC_URL == http* ]]; then
            PIC_URL="https://blog.031312.xyz$PIC_URL" # è¡¥å…¨ç›¸å¯¹è·¯å¾„
          fi
          
          # æž„é€  Markdown æ–‡æœ¬ (ä¼ä¸šå¾®ä¿¡æ”¯æŒå›¾ç‰‡çš„å†™æ³•)
          MARKDOWN_BODY="### ðŸ“ åšå®¢æ–°æ–‡ç« å‘å¸ƒ\n\n**[$POST_TITLE]($BLOG_URL)**\n\n> $POST_DESC\n\n---\nðŸ“‚ **åˆ†ç±»**: $POST_CATE\nðŸ·ï¸ **æ ‡ç­¾**: $POST_TAGS\nðŸ“… **å‘å¸ƒ**: $POST_DATE\n\n![å°é¢å›¾]($PIC_URL)\n\n[ç‚¹å‡»æ­¤å¤„ç«‹å³é˜…è¯»å…¨ç¯‡å†…å®¹ >>]($BLOG_URL)"

          curl -X POST "${{ secrets.MOEPUSH_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"msgtype\": \"markdown\",
                  \"articles\": {
                    \"title\": \"$POST_TITLE\",
                    \"description\": \"$MARKDOWN_BODY\",
                    \"url\": \"$BLOG_URL\",
                    \"picurl\": \"$PIC_URL\"
                  }
                }"
