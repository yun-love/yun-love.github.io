name: Manual Blog Push Test

on:
  workflow_dispatch:

jobs:
  test-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 必须设为 0，否则拿不到 git log 历史

      - name: Extract Post and Push
        run: |
          # 1. 使用 git 寻找最近一次修改的文章路径
          LATEST_POST=$(git log --name-only --format="" src/content/posts/ | grep -E "\.mdx?$" | head -n 1)
          
          echo "Determined latest post by git: $LATEST_POST"

          if [ -z "$LATEST_POST" ]; then
            echo "No post found in git history, falling back to ls."
            LATEST_POST=$(ls src/content/posts/*.{md,mdx} | sort -r | head -n 1)
          fi

          # 2. 提取内容 (保持不变)
          TITLE=$(grep '^title:' "$LATEST_POST" | head -n 1 | sed 's/title: //; s/"//g; s/ '\''//g')
          DESC=$(grep '^description:' "$LATEST_POST" | head -n 1 | sed 's/description: //; s/"//g; s/ '\''//g')
          
          # 3. 构造 URL
          FILENAME=$(basename "$LATEST_POST" | cut -d. -f1)
          BLOG_URL="https://blog.031312.xyz/posts/$FILENAME"

          # 4. 推送
          curl -X POST "${{ secrets.MOEPUSH_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
                  \"msgtype\": \"markdown\",
                  \"articles\": {
                    \"title\": \"$TITLE\",
                    \"description\": \"$DESC\",
                    \"url\": \"$BLOG_URL\"
                  }
                }"
